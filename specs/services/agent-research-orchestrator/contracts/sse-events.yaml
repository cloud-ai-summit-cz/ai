# SSE Event Contract - Trace-Based Architecture
# ==============================================
# All events are derived from Application Insights trace polling.
# Events are streamed to the frontend via Server-Sent Events (SSE).

---
# Event Type Enumeration
event_types:
  - workflow_started      # Research session initialized
  - trace_span_started    # Agent or tool span started
  - trace_span_completed  # Agent or tool span completed
  - trace_tool_call       # Tool invocation detected
  - heartbeat             # Keep-alive signal
  - workflow_completed    # Research workflow finished successfully
  - workflow_failed       # Research workflow failed

---
# Event Schemas

workflow_started:
  description: Emitted when a new research workflow begins
  payload:
    session_id:
      type: string
      description: Unique identifier for the research session
      example: "550e8400-e29b-41d4-a716-446655440000"
    workflow_id:
      type: string
      description: Unique identifier for the workflow execution
      example: "wf_abc123"
    query:
      type: string
      description: The research query being processed
      example: "Analyze the coffee shop market in Prague"
    timestamp:
      type: string
      format: ISO 8601
      example: "2025-01-15T10:30:00Z"

trace_span_started:
  description: Emitted when an agent or operation span begins (from App Insights traces)
  payload:
    session_id:
      type: string
      description: Research session identifier
    workflow_id:
      type: string
      description: Workflow execution identifier
    span_id:
      type: string
      description: Unique identifier for this span
      example: "span_xyz789"
    span_name:
      type: string
      description: Name of the span (agent name or operation)
      example: "MarketAnalyst.run"
    parent_span_id:
      type: string
      nullable: true
      description: Parent span ID if nested
    attributes:
      type: object
      description: Additional span attributes from App Insights
      properties:
        gen_ai.system:
          type: string
          example: "az.ai.agents"
        gen_ai.operation.name:
          type: string
          example: "run"
    timestamp:
      type: string
      format: ISO 8601

trace_span_completed:
  description: Emitted when an agent or operation span completes (from App Insights traces)
  payload:
    session_id:
      type: string
      description: Research session identifier
    workflow_id:
      type: string
      description: Workflow execution identifier
    span_id:
      type: string
      description: Identifier matching the started span
    span_name:
      type: string
      description: Name of the completed span
    duration_ms:
      type: number
      description: Duration of the span in milliseconds
      example: 1523
    status:
      type: string
      enum: [success, error]
      description: Completion status of the span
    error_message:
      type: string
      nullable: true
      description: Error details if status is error
    attributes:
      type: object
      description: Additional span attributes
    timestamp:
      type: string
      format: ISO 8601

trace_tool_call:
  description: Emitted when a tool invocation is detected in traces
  payload:
    session_id:
      type: string
      description: Research session identifier
    workflow_id:
      type: string
      description: Workflow execution identifier
    span_id:
      type: string
      description: Span identifier for the tool call
    tool_name:
      type: string
      description: Name of the tool being called
      example: "scratchpad_write"
    tool_input:
      type: object
      nullable: true
      description: Input parameters to the tool (if ENABLE_SENSITIVE_DATA=true)
    tool_output:
      type: object
      nullable: true
      description: Tool response (if ENABLE_SENSITIVE_DATA=true)
    duration_ms:
      type: number
      nullable: true
      description: Tool execution duration
    status:
      type: string
      enum: [started, completed, error]
    timestamp:
      type: string
      format: ISO 8601

heartbeat:
  description: Keep-alive signal sent periodically to maintain SSE connection
  payload:
    session_id:
      type: string
      description: Research session identifier
    timestamp:
      type: string
      format: ISO 8601
    polls_completed:
      type: integer
      description: Number of App Insights polling cycles completed
      example: 42

workflow_completed:
  description: Emitted when the research workflow completes successfully
  payload:
    session_id:
      type: string
      description: Research session identifier
    workflow_id:
      type: string
      description: Workflow execution identifier
    duration_ms:
      type: number
      description: Total workflow duration in milliseconds
    final_report:
      type: object
      nullable: true
      description: The synthesized research report (if available)
    timestamp:
      type: string
      format: ISO 8601

workflow_failed:
  description: Emitted when the research workflow fails
  payload:
    session_id:
      type: string
      description: Research session identifier
    workflow_id:
      type: string
      nullable: true
      description: Workflow execution identifier if available
    error:
      type: string
      description: Error message
    error_type:
      type: string
      description: Error classification
      example: "timeout"
    duration_ms:
      type: number
      nullable: true
      description: Duration before failure
    timestamp:
      type: string
      format: ISO 8601

---
# SSE Format Specification

sse_format:
  description: |
    Events are sent as Server-Sent Events with the following format:
    
    event: <event_type>
    data: <json_payload>
    
    Each event is followed by a blank line. The client should parse the 
    event type and JSON payload accordingly.
  
  example: |
    event: workflow_started
    data: {"session_id":"550e8400-e29b-41d4-a716-446655440000","workflow_id":"wf_abc123","query":"Analyze coffee shop market","timestamp":"2025-01-15T10:30:00Z"}
    
    event: trace_span_started
    data: {"session_id":"550e8400-e29b-41d4-a716-446655440000","workflow_id":"wf_abc123","span_id":"span_001","span_name":"MarketAnalyst.run","timestamp":"2025-01-15T10:30:01Z"}
    
    event: trace_tool_call
    data: {"session_id":"550e8400-e29b-41d4-a716-446655440000","workflow_id":"wf_abc123","span_id":"span_002","tool_name":"web_search","status":"started","timestamp":"2025-01-15T10:30:02Z"}
    
    event: heartbeat
    data: {"session_id":"550e8400-e29b-41d4-a716-446655440000","timestamp":"2025-01-15T10:30:05Z","polls_completed":3}

---
# Data Sensitivity

sensitive_data:
  description: |
    When ENABLE_SENSITIVE_DATA=true is set in the orchestrator environment,
    additional fields are populated in trace events:
    
    - trace_tool_call: tool_input and tool_output fields contain actual data
    - trace_span_completed: may include prompt/response content in attributes
    
    When ENABLE_SENSITIVE_DATA=false (default), these fields are omitted
    to avoid exposing potentially sensitive information in logs and streams.

---
# Polling Architecture

polling_architecture:
  description: |
    The orchestrator polls Azure Application Insights every 2 seconds
    for new trace data. Traces are processed and converted to SSE events.
    
    Trace sources:
    - Azure AI Agent Service spans (gen_ai.system = "az.ai.agents")
    - Tool call spans
    - Custom telemetry from the orchestrator
    
    The trace_poller module handles:
    1. Querying Log Analytics workspace
    2. Deduplicating spans (by operation_Id + span_id)
    3. Converting trace records to SSE events
    4. Managing polling lifecycle
