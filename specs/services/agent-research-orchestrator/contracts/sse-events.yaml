openapi: 3.1.0
info:
  title: Research Orchestrator SSE Events
  description: |
    Documentation of Server-Sent Events emitted by the Research Orchestrator.
    These events are consumed by the web-research frontend via the `/research/sessions/{id}/start` endpoint.
    
    ## Event Design Philosophy
    
    Events are designed for **discrete status updates**, not state synchronization:
    - SSE events notify the UI that something happened (agent called, tool used, message received)
    - UI should poll scratchpad state via REST API after each event to get current plan/notes/draft
    - This separates "what happened" (SSE) from "current state" (REST polling)
    
    ## Why Polling for Scratchpad State?
    
    Scratchpad updates from subagents are not reliably captured via SSE because:
    - Subagents run their own tool calls internally (not intercepted by orchestrator)
    - Only orchestrator's direct tool calls trigger SSE events
    - Polling ensures UI always has accurate state regardless of which agent made changes
    
    ## Typical Event Flow
    
    1. `session_started` - Workflow begins → UI polls scratchpad
    2. `agent_started` - Orchestrator/agent starts
    3. `tool_call_started` / `tool_call_completed` - Tool invocation (orchestrator only)
    4. `agent_response` - Subagent returned a message → UI polls scratchpad
    5. `agent_completed` - Agent finished
    6. `workflow_completed` - Workflow done → UI polls final scratchpad state
    
    ## Scratchpad Polling
    
    After receiving any SSE event, UI should call:
    - `GET /research/sessions/{id}/scratchpad/plan` - Get current tasks with IDs and statuses
    - `GET /research/sessions/{id}/scratchpad/notes` - Get all notes
    - `GET /research/sessions/{id}/scratchpad/draft` - Get all draft sections
    
  version: 2.0.0

components:
  schemas:
    # Base event structure
    SSEEvent:
      type: object
      required:
        - event_type
        - session_id
        - timestamp
      properties:
        event_type:
          type: string
          description: Type of the event
        session_id:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        data:
          type: object
          description: Event-specific payload

    # === Session Lifecycle Events ===
    
    SessionStartedEvent:
      allOf:
        - $ref: '#/components/schemas/SSEEvent'
        - type: object
          properties:
            event_type:
              const: session_started
            data:
              type: object
              properties:
                query:
                  type: string
                  description: The research query
                message:
                  type: string
                  example: "Research workflow initialized"

    WorkflowCompletedEvent:
      allOf:
        - $ref: '#/components/schemas/SSEEvent'
        - type: object
          properties:
            event_type:
              const: workflow_completed
            data:
              type: object
              properties:
                synthesis:
                  type: string
                  description: Complete final research report (full content)
                total_tool_calls:
                  type: integer
                  description: Number of tool calls made during workflow
                agent_call_counts:
                  type: object
                  additionalProperties:
                    type: integer
                  description: Count of calls per agent tool
                total_time_ms:
                  type: integer
                  description: Total workflow execution time in milliseconds

    WorkflowFailedEvent:
      allOf:
        - $ref: '#/components/schemas/SSEEvent'
        - type: object
          properties:
            event_type:
              const: workflow_failed
            data:
              type: object
              properties:
                error:
                  type: string
                error_type:
                  type: string

    # === Agent Events ===

    AgentStartedEvent:
      allOf:
        - $ref: '#/components/schemas/SSEEvent'
        - type: object
          properties:
            event_type:
              const: agent_started
            data:
              type: object
              properties:
                agent_name:
                  type: string
                  enum: [market-analyst, competitor-analyst, location-scout, finance-analyst, synthesizer]
                task_description:
                  type: string

    AgentProgressEvent:
      allOf:
        - $ref: '#/components/schemas/SSEEvent'
        - type: object
          properties:
            event_type:
              const: agent_progress
            data:
              type: object
              properties:
                agent_name:
                  type: string
                chunk:
                  type: string
                  description: Text chunk from agent (deprecated - use agent_completed instead)
          deprecated: true
          description: |
            DEPRECATED: This event type is no longer emitted by the orchestrator.
            Use `agent_completed` with full content instead.
            Kept for backwards compatibility documentation only.

    AgentThinkingEvent:
      allOf:
        - $ref: '#/components/schemas/SSEEvent'
        - type: object
          properties:
            event_type:
              const: agent_thinking
            data:
              type: object
              properties:
                agent_name:
                  type: string
                message:
                  type: string
                  description: What the agent is thinking about

    AgentCompletedEvent:
      allOf:
        - $ref: '#/components/schemas/SSEEvent'
        - type: object
          properties:
            event_type:
              const: agent_completed
            data:
              type: object
              required:
                - agent_name
                - content
              properties:
                agent_name:
                  type: string
                content:
                  type: string
                  description: Full accumulated content from the agent (not streamed)
                result_summary:
                  type: string
                  description: Optional brief summary (deprecated, use content)
                execution_time_ms:
                  type: integer

    AgentFailedEvent:
      allOf:
        - $ref: '#/components/schemas/SSEEvent'
        - type: object
          properties:
            event_type:
              const: agent_failed
            data:
              type: object
              properties:
                agent_name:
                  type: string
                error:
                  type: string

    # === Tool Call Events ===

    ToolCallStartedEvent:
      allOf:
        - $ref: '#/components/schemas/SSEEvent'
        - type: object
          properties:
            event_type:
              const: tool_call_started
            data:
              type: object
              required:
                - tool_name
                - tool_call_id
                - agent_name
              properties:
                tool_name:
                  type: string
                  description: Name of the MCP tool being called
                  examples: [web_search, add_note, write_draft_section]
                tool_call_id:
                  type: string
                  description: Unique ID for this invocation
                agent_name:
                  type: string
                input_args:
                  type: object
                  description: Arguments passed to the tool

    ToolCallCompletedEvent:
      allOf:
        - $ref: '#/components/schemas/SSEEvent'
        - type: object
          properties:
            event_type:
              const: tool_call_completed
            data:
              type: object
              required:
                - tool_name
                - tool_call_id
                - agent_name
              properties:
                tool_name:
                  type: string
                tool_call_id:
                  type: string
                agent_name:
                  type: string
                output:
                  description: Tool output (type varies by tool)
                execution_time_ms:
                  type: integer

    ToolCallFailedEvent:
      allOf:
        - $ref: '#/components/schemas/SSEEvent'
        - type: object
          properties:
            event_type:
              const: tool_call_failed
            data:
              type: object
              properties:
                tool_name:
                  type: string
                tool_call_id:
                  type: string
                agent_name:
                  type: string
                error:
                  type: string
                error_type:
                  type: string

    # === Agent Response Events ===
    
    AgentResponseEvent:
      allOf:
        - $ref: '#/components/schemas/SSEEvent'
        - type: object
          properties:
            event_type:
              const: agent_response
            data:
              type: object
              required:
                - agent_name
                - response_summary
              properties:
                agent_name:
                  type: string
                  description: Name of the subagent that responded
                  enum: [market-analyst, competitor-analyst, location-scout, finance-analyst, synthesizer]
                response_summary:
                  type: string
                  description: Brief summary or status from the agent (not the full analysis - that goes in scratchpad)
                task_id:
                  type: string
                  description: The task ID this agent was working on (if applicable)
                notes_added:
                  type: integer
                  description: Number of notes the agent added to scratchpad
                draft_sections_written:
                  type: array
                  items:
                    type: string
                  description: Draft section IDs the agent wrote to
          description: |
            Emitted when a subagent completes and returns a response to the orchestrator.
            This event indicates the UI should poll scratchpad for updated notes/draft.
            The agent's factual findings are stored in scratchpad, not in this event.

    # === Scratchpad Events (DEPRECATED) ===
    # These events are deprecated in favor of polling.
    # UI should poll /scratchpad/plan, /scratchpad/notes, /scratchpad/draft after each SSE event.

    ScratchpadUpdatedEvent:
      deprecated: true
      description: |
        DEPRECATED: This event is no longer reliably emitted.
        Scratchpad state should be polled via REST API instead.
        Subagent tool calls are not intercepted by SSE, making this unreliable.
      allOf:
        - $ref: '#/components/schemas/SSEEvent'
        - type: object
          properties:
            event_type:
              const: scratchpad_updated

    ScratchpadSnapshotEvent:
      deprecated: true
      description: |
        DEPRECATED: Use REST API polling instead.
        Poll /scratchpad/plan, /scratchpad/notes, /scratchpad/draft for current state.
      allOf:
        - $ref: '#/components/schemas/SSEEvent'
        - type: object
          properties:
            event_type:
              const: scratchpad_snapshot

    # === Question Events ===

    QuestionAddedEvent:
      allOf:
        - $ref: '#/components/schemas/SSEEvent'
        - type: object
          properties:
            event_type:
              const: question_added
            data:
              type: object
              required:
                - question_id
                - question
                - asked_by
              properties:
                question_id:
                  type: string
                question:
                  type: string
                context:
                  type: string
                  description: Why this question is being asked
                asked_by:
                  type: string
                  description: Agent that asked the question
                priority:
                  type: string
                  enum: [high, medium, low]
                  default: medium
                blocking:
                  type: boolean
                  description: If true, workflow pauses until answered
                  default: false
                options:
                  type: array
                  items:
                    type: string
                  description: Optional multiple choice options

    QuestionAnsweredEvent:
      allOf:
        - $ref: '#/components/schemas/SSEEvent'
        - type: object
          properties:
            event_type:
              const: question_answered
            data:
              type: object
              properties:
                question_id:
                  type: string
                answer:
                  type: string
                answered_at:
                  type: string
                  format: date-time

    # === Synthesis Events ===

    SynthesisStartedEvent:
      allOf:
        - $ref: '#/components/schemas/SSEEvent'
        - type: object
          properties:
            event_type:
              const: synthesis_started
            data:
              type: object
              properties:
                message:
                  type: string
                  example: "Synthesizer agent compiling final report"

    SynthesisProgressEvent:
      allOf:
        - $ref: '#/components/schemas/SSEEvent'
        - type: object
          properties:
            event_type:
              const: synthesis_progress
            data:
              type: object
              properties:
                chunk:
                  type: string
                  description: Text chunk from synthesizer (deprecated - not emitted)
          deprecated: true
          description: |
            DEPRECATED: This event type is no longer emitted.
            Synthesis content is delivered via workflow_completed.synthesis field.

    SynthesisCompletedEvent:
      allOf:
        - $ref: '#/components/schemas/SSEEvent'
        - type: object
          properties:
            event_type:
              const: synthesis_completed
            data:
              type: object
              properties:
                final_report:
                  type: string
                  description: Complete synthesized report
                sections_used:
                  type: array
                  items:
                    type: string
                  description: Scratchpad sections referenced

  # Event type enum for reference
  x-event-types:
    description: All possible SSE event types
    enum:
      # Session lifecycle
      - session_started
      - workflow_completed
      - workflow_failed
      # Agent events
      - agent_started
      - agent_progress      # deprecated
      - agent_thinking
      - agent_completed
      - agent_failed
      - agent_response      # NEW: subagent returned result → poll scratchpad
      # Tool events (orchestrator only)
      - tool_call_started
      - tool_call_completed
      - tool_call_failed
      # Scratchpad events (deprecated - use polling)
      - scratchpad_updated  # deprecated
      - scratchpad_snapshot # deprecated
      # Question events
      - question_added
      - question_answered
      # Synthesis events
      - synthesis_started
      - synthesis_progress  # deprecated
      - synthesis_completed
